{% set backlink = "/" %}
{% extends "layout.html" %}
{% block header %}

	<link rel="stylesheet" href="{{ url_for('static', filename='css/job_details.css') }}">

    <link rel="stylesheet" href="//statgen.github.io/locuszoom/versions/0.3.10/locuszoom.css"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>

	<link rel="stylesheet" href="//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css"/>
	<script type="text/javascript" src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>

    <script type="text/javascript" src="{{ url_for('static', filename='js/ideogram.js') }}"></script>
	
    <script type="text/javascript" src="{{ url_for('static', filename='js/plot.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/job_details.js') }}"></script>
	<script type="text/javascript">
		job_id = "{{ job.job_id }}"
		job_status = "{{ job.status }}"
		job_can_edit = {{ job.can_edit|default(False)|tojson }}
		genome_build = "{{ job.details.genotype.build }}"
		job_api_url = "{{url_for("get_api_job", job_id=job.job_id) }}"
		zoom_api_url = "{{ url_for("get_api_job_zoom", job_id = job.job_id) }}"
		$(document).ready(function() {
			init_job_tabs();
			init_job_cancel_button(job_id);
			if (job_status=="succeeded") {
				init_job_lookup(job_id);
				init_manhattan(job_id);
				init_qqplot(job_id);
				init_tophits(job_id);
			}
			if (job_can_edit) {
				init_editform(job_id, job_api_url);
			}
			if (job_status=="started") {
				init_chunk_progress(job_id);
			}
		});
	</script>
	<style>
		svg .variant_points a {cursor: pointer}
		button.remove:hover { color: red; }
		.label-edit {color: #c4c4c4; font-size:65%; }
		.label-edit:hover {color: black; backgroud-color: #c4c4c4; }
		a.edit-job-modal {text-decoration: none; color:inherit; cursor: pointer}
	</style>

{% endblock %}
{% macro detailtable(job) -%}
	<table id="job_details_table">
		<tr>
			<th>Job Name</th>
			<td>{{ job.name }}</td>
		</tr>
		{% if job.details %}
		<tr>
			<th>Response</th>
			<td>{{ job.details["response"] }}</td>
		</tr>
		<tr>
			<th>Covariates</th>
			<td>{{ ", ".join(job.details.get("covariates",[]) + job.details.get("genopheno",[]) ) }}</td>
		</tr>
		<tr>
			<th>Phenotype</th>
			<td><a href={{url_for("get_pheno", pheno_id=job.details.phenotype.pheno_id) }}>
			{{ job.details.phenotype.name }}</a></td>
		</tr>
		<tr>
			<th>Genotype</th>
			<td>{{ job.details.genotype.name }} ( {{ job.details.genotype.build }} )</td>
		</tr>
		{% endif %}
		<tr>
			<th>Collaborators</th>
			<td><a href="{{ url_for("get_job_share_page", job_id=job.job_id) }}">{{ job.users  | length}} user(s)</a></td>
		</tr>
		<tr>
			<th>Status</th>
			<td>{{ job.status }}</td>
		</tr>
		{% if job.error_message %}
		<tr>
			<th>Error Message</th>
			<td>{{ job.error_message }}</td>
		</tr>
		{% endif %}
		<tr>
			<th>Date Created</th>
			<td>{{ job.creation_date }}</td>
		</tr>
		<tr>
			<th>Last Updated</th>
			<td>{{ job.modified_date }}</td>
		</tr>
	</table>
{%- endmacro %}
{% block content %}
        <div class="section">
            <div class="section-title">
                <h2 id="job_name_title">{{ job.name }}</h2>
                {% if job.status == "queued" or job.status == "started" %}
                <button name="cancel_job">Cancel Job</button>
                {% endif %}
            </div>
        </div>

        {% if job.status == "succeeded" %}

        <div class="section">

            <ul class="tabs">
                <li class="active" rel="tab1">Manhattan</li>
                <li rel="tab2">QQPlot</li>
                <li rel="tab3">Top Hits</li>
                <li rel="tab4">Lookups</li>
                <li rel="tab5">Details</li>
            </ul>
            <div class="tab-container">

                <div id="tab1" class="tab-content"> </div>
                <div id="tab2" class="tab-content"> </div>
				<div id="tab3" class="tab-content">
					<table id="tophits" class="display"></table>
				</div>
                <div id="tab4" class="tab-content">
					<form id="lookup_form"><label for="lookup">Lookup Result:</label> 
					<input id="lookup" size="30" type="text"/> 
					<button>Find</button>
					 (beta test: enter "chr:position", rs-name or gene name)
					</form>
				</div>
				<div id="tab5" class="tab-content">
					{{ detailtable(job) }}
				</div>
            </div>
        </div>
        <form class="section" action="{{ url_for("get_job_output", job_id= job.job_id) }}">
            <button type="submit">Download Output</button>
        </form>

		{% else %}

			<div id="progress"></div>
			{{ detailtable(job) }}

        {% endif %}
		<div class="modal fade" id="editModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Edit Job Details</h4>
					</div>
					<div class="modal-body">
						<form class="form-horizonal">
						<div class="form-group">
							<label class="col-sm-2 control-label" for="job_name">Name</label>
							<div class="col-sm-10"><input type="text" class="form-control" id="job_name"/></div>
						</div>
						&nbsp;
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-success edit-job-save" >Save</button>
					</div>
				</div>
			</div>
		</div>
{% endblock %}
